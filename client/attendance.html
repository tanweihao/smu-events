<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <!-- Always force latest IE rendering engine or request Chrome Frame -->
  <meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible">
  <title>Attendance</title>

  <link href="stylesheets/application.css" media="screen" rel="stylesheet" type="text/css" />

  <!--[if lt IE 9]>
<script src="../../javascripts/html5shiv.js" type="text/javascript"></script><script src="../../javascripts/excanvas.js" type="text/javascript"></script><script src="../../javascripts/iefix.js" type="text/javascript"></script><link href="../../stylesheets/iefix.css" media="screen" rel="stylesheet" type="text/css" /><![endif]-->

  <meta name="viewport" content="width=device-width, maximum-scale=1, initial-scale=1, user-scalable=0">
  <link rel='shortcut icon' href='images/favicon.ico' type='image/x-icon'/ > 
  
</head>
<body>

<div id="modal" class="black-box modal hide fade">
  <div class="modal-header tab-header">
    <button type="button" class="close" data-dismiss="modal">&times;</button>
    <span id="title"></span>
  </div>
  <div class="modal-body separator">
     
  </div>
  <div class="modal-footer">
    <div class="inner-well">
      <a class="button mini rounded light-gray" data-dismiss="modal">Close</a>
      <a class="button mini rounded blue" id="save">Save changes</a>
    </div>
  </div>
</div>

<div id="modal-gallery" class="black-box modal modal-gallery hide fade">
  <div class="modal-header tab-header">
    <button type="button" class="close" data-dismiss="modal">&times;</button>
    <span class="modal-title"></span>
  </div>
  <div class="modal-body"><div class="modal-image"></div></div>
  <div class="modal-footer">
    <div class="pull-left">
      You can also change the images<br/> by scrolling the mouse wheel!
    </div>
    <div class="pull-right">
      <a class="button blue modal-next">Next <i class="icon-arrow-right icon-white"></i></a>
      <a class="button gray modal-prev"><i class="icon-arrow-left icon-white"></i> Previous</a>
      <a class="button green modal-play modal-slideshow" data-slideshow="5000"><i class="icon-play icon-white"></i> Slideshow</a>
      <a class="button black" target="_blank"><i class="icon-download"></i> Download</a>
    </div>
  </div>
</div>
<nav id="primary" class="main-nav">
  <ul>

 
    <li class="active">
      <a href="attendance.html">
        <i class="icon-user"></i> TA
      </a>
    </li>


<li>
          <a href="index.html">
              <i class="icon-off"></i> Log out 
          </a>
        </li>



  </ul>
</nav><nav id="secondary" class="main-nav">

  <div class="profile-menu">

    <div class="pull-left">
      <div class="avatar">
        <img src="images/avatar.png" />
      </div>
    </div>

    <div class="pull-left">
      <div class="title">
        Demo
      </div>
      <div class="btn-group">
        <button class="button mini inset black"><i class="icon-cog"></i>  Settings </button>
      </div>
    </div>

    <div class="pull-right profile-menu-nav-collapse">
      <button class="button black"><i class="icon-reorder"></i></button>
    </div>

  </div>

  <ul class="secondary-nav-menu">
  
<li class="active">
  <a href="attendance.html">
      <i class=" icon-list"></i> Attendance List
        </a>
</li>


  </ul>

</nav>



<section id="main">
  <div class="top-nav">
  <div class="container-fluid">
    <div class="row-fluid search-button-bar-container">
      <div class="span12">
        <ul class="breadcrumb">
           <li><a href="#"><i class="icon-home"></i> TA</a></li>
          <li class="active"><a href="#">Attendance List</a></li>
        </ul>
        <a class="search-button-trigger" href="#"><i class="icon-search"></i></a>
      </div>
    </div>

    <div class="row-fluid search-bar-nav">
      <div class="span12">
        <form>
          <input type="text" class="search" placeholder="Search...">
        </form>
      </div>
    </div>
  </div>
</div>

  <div class="container-fluid">
    <div class="row-fluid">
  
  <div class="span12" style="min-height:500px;">
  	<div class="btn-group" >
       <!-- <button class="button" id="selectedClass" style="width:200px;">Select Class</button>
        <button class="button  dropdown-toggle" data-toggle="dropdown">
          <span class="caret"></span>
        </button>
        <ul class="dropdown-menu" id="classList" style="width:200px;">
          
        </ul>-->
        <select id="classList">
    		
  		</select>
      </div>
      <div class="btn-group">
        <!--<button class="button ">Select Week</button>
        <button class="button  dropdown-toggle" data-toggle="dropdown">
          <span class="caret"></span>
        </button>
        <ul class="dropdown-menu" style="overflow-y:scroll;">
          <li><a href="#">Week 1</a></li>
          <li><a href="#">Week 2</a></li>
          <li><a href="#">Week 3</a></li>
           <li><a href="#">Week 4</a></li>
          <li><a href="#">Week 5</a></li>
          <li><a href="#">Week 6</a></li>
           <li><a href="#">Week 7</a></li>
          <li><a href="#">Week 8</a></li>
          <li><a href="#">Week 9</a></li>
          <li><a href="#">Week 10</a></li>
          <li><a href="#">Week 11</a></li>
           <li><a href="#">Week 12</a></li>
          <li><a href="#">Week 13</a></li>
        </ul>-->
       		 <select id="weekList">
    			 <option value="1" selected="selected">Week 1</option>
    			 <option value="2">Week 2</option>
    			 <option value="3">Week 3</option>
    			 <option value="4">Week 4</option>
    			 <option value="5">Week 5</option>
    			 <option value="6">Week 6</option>
    			 <option value="7">Week 7</option>
    			 <option value="8">Week 8</option>
    			 <option value="9">Week 9</option>
    			 <option value="10">Week 10</option>
    			 <option value="11">Week 11</option>
    			 <option value="12">Week 12</option>
    			 <option value="13">Week 13</option>
  			</select>
      </div>
      <br/> <br/>
    <div class="box" style="position:relative;">
    
<div class="tab-header" >
  Student List
</div>
<table class="table table-striped data-table">
<!--<thead>
<tr>
  <th>Name</th>
  <th>Attendance</th>
  <th>Class Participation</th>
</tr>
</thead>
<tbody  id="studentList">
</tbody>-->
</table>
</div>
  </div>
</div>
    <div class="row-fluid">
  <div class="span12">
    <div class="footer">
     
    </div>
  </div>
</div>
  </div>
</section>

<script type="text/html" id="template-notification">
  <div class="notification animated fadeInLeftMiddle fast{{ item.itemClass }}">
    <div class="left">
      <div style="background-image: url({{ item.imagePath }})" class="{{ item.imageClass }}"></div>
    </div>
    <div class="right">
      <div class="inner">{{ item.text }}</div>
      <div class="time">{{ item.time }}</div>
    </div>

    <i class="icon-remove-sign hide"></i>
  </div>
</script>
<script type="text/html" id="template-notifications">
  <div class="container">
    <div class="row" id="notifications-wrapper">
      <div id="notifications" class="{{ bootstrapPositionClass }} notifications animated">
        <div id="dismiss-all" class="dismiss-all button blue">Dismiss all</div>
        <div id="content">
          <div id="notes"></div>
        </div>
      </div>
    </div>
  </div>
</script>
<script src="javascripts/application.js" type="text/javascript"></script>
<script src="javascripts/jquery.timepicker.min.js" type="text/javascript"></script>
<script src="javascripts/docs.js" type="text/javascript"></script>
<script src="javascripts/docs_charts.js" type="text/javascript"></script>
<script src="javascripts/documentation.js" type="text/javascript"></script>
<script src="javascripts/prettify.js" type="text/javascript"></script>
<link href="stylesheets/prettify.css" media="screen" rel="stylesheet" type="text/css" />
<script src="/socket.io/socket.io.js"></script>
    <script>
        var socket = io.connect(window.location.hostname);
        socket.on('connect', function(data) {
            if(!readCookie("socketSession") || readCookie("socketSession") == null || readCookie("socketSession") == false || readCookie("socketSession") == undefined ){
                createCookie("socketSession",true,3);
            }
            socket.emit('identify', { client_name: readCookie("taId") });
        });
        
        socket.on('register_notify', function(data) {
            Notifications.push({
                text: "<i class='icon-success-sign'>"+data.student_name+" has registered up for the class "+data.class_code+" "+data.class_name+"</i> !",
                autoDismiss: 10,
                "class": "success"
            });
        });
            
            
    </script>
<script type="text/javascript">
    prettyPrint()
</script>

<script type="text/javascript">
  if(readCookie("username")==undefined ||readCookie("username")=="" || readCookie("username")==null ){
            window.location.replace('index.html');
      }else{
          $('.title').text(readCookie("username"));
      }
      getClassList();
      var classById ={}; var studentById = {};var oTable;
      function getClassList(){
      		var taId = 'ta_Id='+readCookie("taId");
      		
     	 $.ajax({
    		url: "http://smu-events.herokuapp.com/api/classes/class_list",
			type: "GET",
			data:taId,
			contentType: "application/json",
    		success:function(json) {
    			
    			var sb = [];
    			$(json).each(function(i,e){
      				classById[e._id] = e;
      					$("#classList").empty();
      					if(i==0){
      						//$("#selectedClass").text(e.class_code+" - "+e.class_name);
      						sb.push('<option id="class" oid="'+e._id+'" selected="selected">'+e.class_code+' - '+e.class_name+'</option>');
      						populateStudentList(e._id,1);
      					}else{
      						sb.push('<option id="class" oid="'+e._id+'">'+e.class_code+' - '+e.class_name+'</option>');
      					}
      			});
      			$("#classList").append(sb.join(''));
      		
    		}
   	 	});
      }
      
      function populateStudentList(classId,week){
      	var sb = [];
      	
      	var data = 'class_id='+classId+'&week='+week;
      	
      	$.ajax({
    		url: "http://smu-events.herokuapp.com/api/classes/class_list",
			type: "GET",
			data:data,
			contentType: "application/json",
    		success:function(json) {
    			
    			var locations = [];
				$(json).each(function(i, obj) {
					studentById[obj.uid] = obj;
					locations.push([obj.uid,obj.name, (obj.attendance==1?"Yes":"No"),obj.class_part]);
   					
				});
    			console.log(locations);
    			
    			//Delete the datable object first
				if(oTable != null)oTable.fnDestroy();
				//Remove all the DOM elements
				$('.data-table').empty();
    			oTable = $('.data-table').dataTable( {
        			"aaData":locations,
        			"aoColumns": [
        				{ "sTitle": "ID" },
            			{ "sTitle": "Name" },
           				{ "sTitle": "Attendance" },
           				{ "sTitle": "Class Participation" }
        			],"bJQueryUI": true,
      				"sPaginationType": "full_numbers",
      				"sDom": '<""l>t<"F"fp>'
   				});   
   				//var bVis = oTable.fnSettings().aoColumns[0].bVisible;
    			oTable.fnSetColumnVis( 0, false);
    			/*$(json).each(function(i,e){
    				studentById[i] = e;
    				$("#studentList").empty();
      				sb.push('<tr class="gradeX" id="student" oid="'+i+'"><td>'+e.name+'</td><td>'+(e.attendance==1?"Yes":"No")+'</td><td>'+e.email+'</td></tr>');
    			});
    			$("#studentList").append(sb.join(''));*/
    		}
   	 	});
      }
      
      $( "#classList" ).change(function() {
  		populateStudentList($("#classList option:selected").attr('oid'),$("#weekList option:selected").val());
	  });
	  
	  $( "#weekList" ).change(function() {
  		populateStudentList($("#classList option:selected").attr('oid'),$("#weekList option:selected").val());
	  });
      
      $(".data-table tbody tr").live("click", function(event){
    		var position = oTable.fnGetPosition(this); // getting the clicked row position
    		var id = oTable.fnGetData(position)[0];    // getting the value of the first (invisible) column
    		console.log(position+" "+id);
    		editStudent(studentById[id]);
      });
      
      function editStudent(student){
      	var sb = [];
      	$("#title").empty();
      	$(".modal-body").empty();
      	$("#title").append("<h5>Update Student ["+student.name+"] </h5>");
      	//<input type="button" value="-" class="qtyminus" field="quantity" /><input type="text" name="quantity" value="0" class="qty" /><input type="button" value="+" class="qtyplus" field="quantity" />
      	
		sb.push('<div class="span4"><div class="row">');
		sb.push('<div class="span1"><a href="#" class="thumbnail" style="text-decoration:none;"><img src="images/avatar.png"></a></div>');
    	sb.push('<div class="span3"><p>Student ID: '+student.uid+'</p><p><strong>Student Name: '+student.name+'</strong></p><p>Attendance: '+(student.attendance==1?"Yes":"No")+'</p><p>Class Part: <a id="minus" href="#" style="font-size:18px;margin-right:5px;margin-left:5px;"><i class="icon-minus"></i></a><span id="value" style="min-width:20px;min-height:20px;font-size:18px;">'+student.class_part+'</span><a id="plus" href="#" style="margin-left:5px;font-size:18px;"><i class="icon-plus"></i></a></p></div></div>');
    	sb.push('</div></div>');
      	$(".modal-body").append(sb.join(''));
      	var valueElement = $('#value');
    	function incrementValue(e){
       		valueElement.text(Math.max(parseInt(valueElement.text()) + e.data.increment, 0));
       		valueElement.css({"min-width":"20px","min-height":"20px"});
        	return false;
    	}

    	$('#plus').bind('click', {increment: 1}, incrementValue);

    	$('#minus').bind('click', {increment: -1}, incrementValue);
      	
      	$("#save").bind('click', function(e){
      		var stu = student;
      		e.preventDefault();
      		console.log(stu);
      		//update class part
      		var studentData = '{"class_id":"'+$("#classList option:selected").attr('oid')+'","uid":'+stu.uid+',"week":'+$("#weekList option:selected").val()+',"class_part":'+Math.max(parseInt($("#value").text()))+'}';
      		 $.ajax({
    	    url: "http://smu-events.herokuapp.com/api/classes/update_c",
		    type: "POST",
    		contentType: "application/json",
		    data: studentData,
		    error:function(){
		            Notifications.push({
                        text: "<i class='icon-warning-sign'></i>Error : Cannot update class part for student ["+stu.name+"]. Please try again.",
                        autoDismiss: 3,
                        "class": "error"
                    });
		    },
    	    success:function(json) {
    	        console.log(json);
    	        if(json.result==-1){
    	            Notifications.push({
                        text: "<i class='icon-warning-sign'></i>Error : Error updating class part for student ["+stu.name+"]. Please try again.",
                        autoDismiss: 3,
                        "class": "error"
                    });
    	        }else{
    	            Notifications.push({
                        text: "<i class='icon-success-sign'></i> Successfully updated class part for student ["+stu.name+"]!",
                        autoDismiss: 3,
                        "class": "success"
                    });
                    $("#save").unbind( "click" );
                    $("#modal").modal('hide');
                    populateStudentList($("#classList option:selected").attr('oid'),$("#weekList option:selected").val());
                   //window.location.replace('fullcalendar.html');
    	        }
    	        
    	    }
        });
      		//end
      	});
      	
      	$("#modal").modal('show');
      }
      
</script>

</body>
</html>
